{% extends 'base.html' %}
{% block title %}Blog | The Super Blog{% endblock title %}
{% load static %}

{% block content %}
<div class="container">
  <div class="layout">
    <!-- left layout -->
    <div class="left">
      <div class="page-top">
        <div class="top flex">
          <div class="page-name">
            <a href="{% url "app:home" %}" class="learn">
              <span class="material-icons"> keyboard_return </span> Go back
            </a>
            <h1>Blog</h1>
          </div>
        </div>
      </div>

      <center>
        <div class="typo">
          <h1 class="title blog-title">
            {{post.title}}
          </h1>
          <div class="timeline">
            <div class="track">
              <i class="uil uil-clock"></i>
              <p class="time">{{post.last_updated|date}}</p>
            </div>
            <div class="track">
              <i class="uil uil-users-alt"></i>
              <p class="view-count">{{post.view_count}} view{{post.view_count|pluralize}}</p>
            </div>
            <div class="track">
              {% if user.is_authenticated %}
              <form action="{% url 'app:bookmark_post' post.slug %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="post_id" value="{{post.id}}">
                {% if is_bookmarked %}
                <button type="submit" class="btn btn-info">
                  <i class="fa-solid fa-bookmark"></i>
                  <p class="bookmark">Remove Bookmark</p>
                </button>
                {% else %}
                <button type="submit" class="btn btn-info">
                  <i class="uil uil-bookmark-full"></i>
                  <p class="bookmark">Bookmark</p>
                </button>
                {% endif %}
              </form>
              {% else %}
              <a class="track" href="{% url 'login' %}">
                <i class="uil uil-bookmark-full"></i>
                <p class="bookmark">Bookmark</p>
              </a><br>
              {% endif %}
            </div>
          </div>
        </div>
      </center>

      <section class="mt">
        <div class="container">
          <!-- blog post -->
          <div class="blog-post">
            <div class="post-img blog-img">
              {% if post.image %}<img src="{{post.image.url}}" alt="{{ post.title }}" />{% endif %}
            </div>
            <div class="blog-post-content">
              <p>
                {{post.content|safe}}
              </p>
              <div class="blog-tags">
                {% for tag in post.tags.all %}
                <a href="{% url 'tag_page' tag.slug %}" class="tag">{{tag.name}}</a>
                {% endfor %}
              </div>
              <div class="social-share">
                <div class="reactions">
                  <div class="likes">
                    {% if user.is_authenticated %}
                    <form action="{% url 'app:like_post' post.slug %}" method="post">
                      {% csrf_token %}
                      <input type="hidden" name="post_id" value="{{post.id}}">
                      {% if is_liked %}
                      <button type="submit">
                        <i class="fa-solid fa-heart"></i> <span>{{number_of_likes}}</span>
                      </button>
                      {% else %}
                      <button type="submit">
                        <i class="fa-regular fa-heart"></i> <span>{{number_of_likes}}</span>
                      </button>
                      {% endif %}
                    </form>
                    {% else %}
                    <a class="track" href="{% url 'login' %}">
                      <i class="uil uil-heart"></i> <span>{{number_of_likes}}</span>
                    </a><br>
                    {% endif %}
                  </div>

                  <div class="total-comments">
                    <i class="uil uil-comment-alt"></i>
                    <span>{{ comments|length }}</span>
                  </div>
                </div>
                {% comment %} <div class="share">
                  <div class="social">
                    <a href="#">
                      <i class="fa-brands fa-facebook-f"></i>
                    </a>
                    <a href="#">
                      <i class="fa-brands fa-instagram"></i>
                    </a>
                    <a href="#">
                      <i class="fa-brands fa-linkedin-in"></i>
                    </a>
                    <a href="#">
                      <i class="fa-brands fa-twitter"></i>
                    </a>
                  </div>
                </div> {% endcomment %}
              </div>

              <!-- ========== COMMENTS SECTION ========== -->
              {% if comments %}
              <div class="comments-section mt-5">
                <h3 class="mb-4">Comments ({{ comments|length }})</h3>

                {% for comment in comments %}
                <div class="comment">
                  <div class="comment-header">
                    <strong>{{ comment.name }}</strong>
                    <small class="text-muted">{{ comment.date }}</small>
                  </div>
                  <p>{{ comment.content }}</p>

                  <!-- Replies -->
                  {% if comment.replies.all %}
                  <div class="replies ml-4" style="margin-left: 20px;">
                    {% for reply in comment.replies.all %}
                    <div class="reply" style="border-left: 2px solid #ddd; padding-left: 10px; margin-bottom: 10px;">
                      <strong>{{ reply.name }}</strong>
                      <small class="text-muted">{{ reply.date }}</small>
                      <p>{{ reply.content }}</p>
                    </div>
                    {% endfor %}
                  </div>
                  {% endif %}

                  <!-- Reply Form -->
                  {% if user.is_authenticated %}
                  <div class="reply-form" style="margin-top: 10px;">
                    <form method="POST">
                      {% csrf_token %}
                      <label class="small"><strong>Reply as: {{ user.first_name|default:user.username }}</strong></label>
                      {{ form.content }}
                      <input type="hidden" name="parent" value="{{ comment.id }}">
                      <input type="hidden" name="post_id" value="{{ post.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-primary">Reply</button>
                    </form>
                  </div>
                  {% else %}
                  <p class="small"><a href="{% url 'login' %}">Login</a> to reply</p>
                  {% endif %}
                </div>
                <hr>
                {% endfor %}
              </div>
              {% endif %}

              <!-- ========== COMMENT FORM ========== -->
              <div class="comment-form mt-5">
                {% if user.is_authenticated %}
                <h3 class="mb-3">Leave a new comment to this post</h3>
                <form method="POST">
                  {% csrf_token %}
                  <label><strong>Commenting as: {{ user.first_name|default:user.username }}</strong></label>
                  {{ form.content }}
                  <input type="hidden" name="post_id" value="{{ post.id }}">
                  <button type="submit" class="btn btn-secondary mt-3">Post comment</button>
                </form>
                {% else %}
                <div class="alert alert-info">
                  Please <a href="{% url 'login' %}"><strong>login</strong></a> or <a href="{% url 'register' %}"><strong>sign up</strong></a> to comment.
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!-- left layout end -->

    <!-- right layout -->
    <div class="right">
      <div class="block">
        <h2 class="title2">Most recent</h2>
        {% for post_item in recent_posts %}
        <div class="recent-post">
          <div class="rounded-img">
            {% if post_item.image %}<img src="{{post_item.image.url}}" alt="{{ post_item.title }}" />{% endif %}
          </div>
          <div class="recent-content">
            <h3>
              {{post_item.title}}
            </h3>
            <a class="learn" href="{% url 'app:post_page' post_item.slug %}"
              >Learn more
              <span class="material-icons"> trending_flat </span></a
            >
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="block r-blog">
        <h2 class="title2">Related Blogs</h2>
        {% for post_item in related_posts %}
        <!-- card -->
        <a href="{% url 'post_page' post_item.slug %}">
          <div class="card">
            <div class="post-img">
              {% if post_item.image %}<img src="{{post_item.image.url}}" alt="{{ post_item.title }}" />{% endif %}
              <div class="tag">{{post_item.tags.all.0.name}}</div>
            </div>
            <div class="card-content">
              <h3>
                {{post_item.title}}
              </h3>
              <div class="author">
                <div class="profile-pic">
                  <img src="{% static 'images/author.svg' %}" alt="" />
                </div>
                <div class="details">
                  <p>{{post_item.author.first_name}}</p>
                  <small>{{post_item.last_updated | date}}</small>
                </div>
              </div>
            </div>
          </div>
        </a>
        <!-- card end-->
        {% endfor %}
      </div>

      <div class="block r-blog">
        <h2 class="title2">Top Authors</h2>
        {% for author in top_authors %}
        <!-- card -->
          {% if author.profile.slug %}
            <a href="{% url "app:author_page" author.profile.slug %}">
          {% endif %}
          {% comment %} <a href="{% url "author_page" author.profile.slug %}"> {% endcomment %}
          <div class="card">
            <div class="card-content">
              <h3>
                {{author.profile.bio}}
              </h3>
              <div class="author">
                <div class="profile-pic">
                  <img src="{% static 'images/author.svg' %}" alt="" />
                </div>
                <div class="details">
                  <p>{{author.first_name}}</p>
                </div>
              </div>
            </div>
          </div>
        </a>
        <!-- card end-->
        {% endfor %}
      </div>

      <div class="block">
        <h2 class="title2">Top Tags</h2>
        {% for tag in tags %}
        <div class="blog-tags">
          <a href="{% url 'tag_page' tag.slug %}" class="tag">{{tag.name}}</a>
        </div>
        {% endfor %}
      </div>
    </div>
    <!-- right layout end -->
  </div>
</div>

{% endblock content %}
